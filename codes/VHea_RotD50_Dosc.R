VHea.RotD50.Dosc <- function(M,Rrup,Vs30,f0,xi){
  ############################ INPUTS #################################
  #   M     = moment magnitude
  #   Rrup  = closest distance to rupture plane (km)
  #   Vs30  = time-averaged shear-wave velocity in top 30 m
  #   f0    = oscillator frequency (Hz)
  #           input any values >= 0.1 Hz, or
  #           input -1 to output a spectrum of oscillator durations
  #   xi    = single-degree-of-freedom oscillator damping (%)
  #           input either 0.05 or 0.2
  ############################ OUTPUTS ################################
  #   A matrix with columns corresponding to f0, and the following rows
  #   Row 1 = repeat of f0 input (Hz)
  #   Row 2 = RotD50 oscillator duration (s)
  #   Row 3 = event level standard deviation, phi_e
  #   Row 4 = site level standard deviation, phi_s
  #   Row 5 = site level standard deviation, phi_p
  #####################################################################
  freq <- c(1000,100,50,33.3333,25,20,13.3333,10,6.6667,5,4,3.3333,2.5,2,1.3333,1,0.6667,0.5,0.3333,0.25,0.2,0.1333,0.1)
  
  if (length (f0) == 1 && f0 < 0){
    out<-matrix(data=NA,nrow=5,ncol=length(freq))
    # Run all frequencies through model
    for (ip in 1:length(freq)){
      indv<-VHea.RotD50.Dosc.mod(M,ip,Rrup,Vs30,xi)
      out[1,ip]<-freq[ip]
      out[2,ip]<-indv$Dgm
      out[3,ip]<-indv$phi.e
      out[4,ip]<-indv$phi.s
      out[5,ip]<-indv$phi.p
    }  
  } else if (length (f0) == 1 && f0>100){
    ip <- 1
    indv<-VHea.RotD50.Dosc.mod(M,ip,Rrup,Vs30,xi)
    out<-matrix(data=NA,nrow=5,ncol=1)
    out[1,1] <- f0
    out[2,1] <- indv$Dgm
    out[3,1] <- indv$phi.e
    out[4,1] <- indv$phi.s
    out[5,1] <- indv$phi.p
  } else if (!anyNA(match(f0,freq))){
    ip<-match(f0,freq)
    out<-matrix(data=NA,nrow=5,ncol=length(ip))   
    indv<-VHea.RotD50.Dosc.mod(M,ip,Rrup,Vs30,xi)
    out[1,]<-freq[ip]
    out[2,]<-indv$Dgm
    out[3,]<-indv$phi.e
    out[4,]<-indv$phi.s
    out[5,]<-indv$phi.p
  } else if (anyNA(match(f0,freq))){
    out<-matrix(data=NA,nrow=5,ncol=length(f0))
    for (ind in 1:length(f0)){
      if (f0[ind] >= max(freq)){
        indv<-VHea.RotD50.Dosc.mod(M,1,Rrup,Vs30,xi)
        out[1,ind] <- f0[ind]
        out[2,ind] <- indv$Dgm
        out[3,ind] <- indv$phi.e
        out[4,ind] <- indv$phi.s
        out[5,ind] <- indv$phi.p
      } else if (f0[ind] == min(freq)){
        indv<-VHea.RotD50.Dosc.mod(M,23,Rrup,Vs30,xi)
        out[1,ind] <- f0[ind]
        out[2,ind] <- indv$Dgm
        out[3,ind] <- indv$phi.e
        out[4,ind] <- indv$phi.s
        out[5,ind] <- indv$phi.p
      } else if (f0[ind] > min(freq) & f0[ind] < max(freq)){
        f1<-freq[which(abs(f0[ind]-freq)==min(abs(f0[ind]-freq)))]
        f2<-ifelse(f0[ind]>f1,freq[which(freq==f1)-1],freq[which(freq==f1)+1])
        
        indv1<-VHea.RotD50.Dosc.mod(M, which(freq==f1), Rrup,Vs30,xi)
        Dgm1<-indv1$Dgm
        phi.e1<-indv1$phi.e
        phi.s1<-indv1$phi.s
        phi.p1<-indv1$phi.p
        
        indv2<-VHea.RotD50.Dosc.mod(M, which(freq==f2), Rrup,Vs30,xi)
        Dgm2<-indv2$Dgm
        phi.e2<-indv2$phi.e
        phi.s2<-indv2$phi.s
        phi.p2<-indv2$phi.p
        
        out[1,ind] <- f0[ind]
        out[2,ind] <- exp(approx(x=c(log(f1),log(f2)),y=c(log(Dgm1),log(Dgm2)),xout=log(f0[ind]))$y)
        out[3,ind] <- approx(x=c(log(f1),log(f2)),y=c(phi.e1,phi.e2),xout=log(f0[ind]))$y
        out[4,ind] <- approx(x=c(log(f1),log(f2)),y=c(phi.s1,phi.s2),xout=log(f0[ind]))$y
        out[5,ind] <- approx(x=c(log(f1),log(f2)),y=c(phi.p1,phi.p2),xout=log(f0[ind]))$y    
      } else {
        stop("Specified frequency is outside model range")
      }
    }
  }
  return(out)
}

VHea.RotD50.Dosc.mod <- function(Mw,ip,Rrup,Vs30,xi){
  if (xi==0.05){
    b0  <- c(-1.7204,-1.7205,-1.6089,-1.4624,-1.5382,-1.3650,-2.0799,-1.5936,-2.8691,-2.6023,-1.8391,-0.7571,-0.4658,-0.3375,0.0164,0.3020,0.2972,0.0239,0.6697,0.4542,0.2081,0.7695,1.9169)
    b1  <- c(0.2272,0.2272,0.2260,0.2177,0.2067,0.2317,0.2139,0.2924,0.2465,0.2539,0.2317,0.2575,0.1765,0.1491,0.0900,0.0857,0.0846,0.0654,0.1373,0.0978,0.1008,0.1381,0.2783)                      
    b2  <- c(0.0967,0.0967,0.1001,0.0990,0.0935,0.0874,0.0746,0.0655,0.0887,0.1136,0.1357,0.1305,0.1642,0.1691,0.1253,0.1032,0.0702,0.0682,0.0216,0.0822,0.0906,0.0140,0.0000)                      
    b3  <- c(0.8870,0.8870,0.8643,0.8435,0.8760,0.8480,1.0208,0.8993,1.1480,1.0503,0.8668,0.6276,0.5532,0.5355,0.5154,0.4882,0.5522,0.6638,0.5887,0.6328,0.6763,0.5821,0.3050)                      
    b4  <- c(2.7641,2.7641,2.7258,2.6635,2.7010,2.5000,2.8719,2.5000,3.2929,3.2971,3.1404,2.5000,2.3575,2.5000,1.7893,1.5823,1.4805,2.5000,2.1089,2.5058,2.7324,2.5624,2.5000)                      
    b5  <- c(0.5777,0.5776,0.5778,0.5756,0.5602,0.5000,0.4983,0.5000,0.3528,0.3066,0.4380,0.5000,0.6725,0.5000,0.8819,0.6950,0.7958,0.5000,0.5381,0.4643,0.3668,0.6913,0.5000)                      
    b6  <- c(1.1700,1.1699,1.1715,1.1312,1.0702,1.0297,0.9346,1.0110,1.0104,1.0800,1.2592,1.2277,1.2655,1.1424,0.8960,0.7493,0.4679,0.2279,0.0691,0.2098,0.3044,-0.0662,0.0636) 
    b7  <- c(-0.1413,-0.1413,-0.1342,-0.1158,-0.0996,-0.0950,-0.0834,-0.0723,-0.0806,-0.1327,-0.1179,-0.1045,-0.1381,-0.1538,-0.1577,-0.1687,-0.1621,-0.1215,-0.0939,-0.0834,-0.0880,-0.0513,0.0074)
    phi.e  <- c(0.2270,0.2270,0.2269,0.2089,0.1858,0.1757,0.1868,0.2425,0.2328,0.2236,0.2032,0.1716,0.1926,0.2038,0.1988,0.2302,0.1874,0.1794,0.1358,0.1056,0.0914,0.1687,0.1680)                   
    phi.s  <- c(0.2403,0.2402,0.2388,0.2386,0.2330,0.2266,0.2008,0.1916,0.1803,0.1898,0.1761,0.1835,0.1778,0.1650,0.1647,0.1965,0.2129,0.2044,0.1898,0.1885,0.2802,0.2087,0.0591)                   
    phi.p  <- c(0.3399,0.3399,0.3337,0.3224,0.3176,0.3034,0.2902,0.2948,0.3233,0.3534,0.3608,0.3497,0.3570,0.3525,0.3540,0.3648,0.3557,0.3617,0.3432,0.2945,0.3000,0.2208,0.2539)
  } else if (xi==0.2){
    b0  <- c(-1.7204,-1.7198,-1.6602,-1.6589,-1.7012,-1.7643,-1.9239,-1.5178,-2.2874,-2.0496,-1.7676,-1.1500,-0.9829,-0.9699,-0.6143,-0.5492,-0.5671,-1.0478,-0.5070,-0.7536,-1.0302,-1.1544,-0.4648)
    b1  <- c(0.2272,0.2271,0.2264,0.2228,0.2186,0.2176,0.2285,0.2845,0.2524,0.2493,0.2393,0.2602,0.2053,0.1813,0.1438,0.1463,0.1623,0.1482,0.2255,0.2335,0.1664,0.3212,0.3888)
    b2  <- c(0.0967,0.0967,0.0976,0.0940,0.0922,0.0904,0.0842,0.0803,0.0905,0.1080,0.1168,0.1251,0.1477,0.1575,0.1221,0.0888,0.0578,0.0406,-0.0218,-0.0009,0.0344,-0.0651,0.0000)
    b3  <- c(0.8870,0.8869,0.8758,0.8818,0.8974,0.9160,0.9526,0.8508,0.9988,0.9237,0.8538,0.7136,0.6738,0.6802,0.6428,0.6639,0.7147,0.8633,0.7943,0.8545,0.9176,0.9373,0.7285)
    b4  <- c(2.7641,2.7636,2.7447,2.7511,2.7805,2.8092,2.8651,2.5000,3.0557,2.9899,2.8973,2.5000,2.4142,2.5000,1.8625,1.7005,1.5234,2.5000,1.8120,2.0673,2.2266,2.2894,2.5000)
    b5  <- c(0.5777,0.5779,0.5771,0.5723,0.5613,0.5525,0.5299,0.5000,0.4495,0.4821,0.5422,0.5000,0.6866,0.5000,0.8738,0.8917,0.9535,0.5000,0.8205,0.7925,0.8027,0.8609,0.5000)
    b6  <- c(1.1699,1.1698,1.1678,1.1487,1.1273,1.1111,1.0993,1.1298,1.1665,1.2260,1.2622,1.2621,1.2637,1.1445,0.9784,0.8017,0.5977,0.3948,0.3239,0.2620,0.2928,0.0917,0.1493) 
    b7  <- c(-0.1413,-0.1412,-0.1359,-0.1266,-0.1179,-0.1107,-0.1051,-0.1136,-0.1364,-0.1658,-0.1674,-0.1649,-0.1860,-0.2041,-0.2114,-0.2132,-0.2071,-0.1724,-0.1273,-0.1286,-0.1152,-0.1202,-0.0801)
    phi.e  <- c(0.2270,0.2270,0.2269,0.2234,0.2166,0.2116,0.2273,0.2672,0.2546,0.2520,0.2311,0.2219,0.2221,0.2289,0.2358,0.2678,0.2636,0.2532,0.2026,0.1997,0.1711,0.2006,0.2013)
    phi.s  <- c(0.2402,0.2403,0.2384,0.2384,0.2368,0.2333,0.2251,0.2295,0.2230,0.2210,0.2201,0.2256,0.2203,0.2179,0.2170,0.2354,0.2699,0.2772,0.2995,0.3077,0.3227,0.3054,0.1744)
    phi.p  <- c(0.3399,0.3398,0.3360,0.3311,0.3265,0.3234,0.3196,0.3221,0.3356,0.3483,0.3527,0.3553,0.3623,0.3635,0.3698,0.3832,0.3826,0.4012,0.3715,0.3497,0.3366,0.2958,0.3201)
  } else {
    stop("Damping level not currently supported")
  }

  R1 <- function (R,bp,fic.dep) {ifelse(R<=bp & fic.dep>0,log(sqrt(R^2+fic.dep^2)),log(sqrt(bp^2+fic.dep^2)))}
  R2 <- function (R,bp,fic.dep) {ifelse(R<=bp & fic.dep>0,0,log(sqrt(R^2+fic.dep^2))-log(sqrt(bp^2+fic.dep^2)))}
  
  Mwsc <- Mw - 6  
  Hinge <- 100
  lnDgm <- b0[ip] + b1[ip]*Mwsc + b2[ip]*Mwsc^2 + b3[ip]*R1(Rrup,Hinge,exp(b4[ip]+b5[ip]*Mwsc)) + b6[ip]*R2(Rrup,Hinge,exp(b4[ip]+b5[ip]*Mwsc)) + b7[ip]*log(Vs30/1000)
  Dgm <- exp(lnDgm)
  
  res<-vector("list",4)
  names(res)<-c("Dgm","phi.e","phi.s","phi.p")
  res$Dgm<-Dgm
  res$phi.e<-phi.e[ip]
  res$phi.s<-phi.s[ip]
  res$phi.p<-phi.p[ip]
  return(res)
}
