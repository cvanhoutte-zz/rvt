RVT <- function(f,FA,f0,xi,M,R,pf.model,nf,Dgm){
  #
  # Requires R packages {fields} and {pracma}
  #
  #######################################################
  #
  # This script converts a Fourier amplitude spectrum
  # of acceleration to a SDOF response spectral 
  # acceleration (PSA) ordinate, using random vibration 
  # theory (RVT).
  #
  # The Boore and Thompson (2012) model can be used to
  # calculate the 'RMS duration', using WUS coefficients.
  # These coefficients are tuned to work with either the
  # Cartwright and Longuet-Higgins (1956), or the
  # Vanmarcke (1975) peak factors.
  #
  # The Caughey and Stumpf (1961) and Corotis (1970)
  # nonstationarity corrections can also be specified.
  #
  ################### INPUTS ###########################
  #
  # f   = vector of frequencies (must be positive)
  # FA  = vector of Fourier amplitudes
  # f0  = response spectral oscillator frequency
  # xi  = oscillator damping. Usually = 0.05 (5%),
  #       care should be taken if using other values
  # M   = moment magnitude (required for BT2015 model)
  # R   = distance (km) (required for BT2015 model)
  # pf  = selected peak factor formulation. Options are
  #       "CL1956" for the Cartwright and Longuet-Higgins
  #       (1956) model, or "V1975" for the Vanmarcke
  #       (1975) model.
  # nf  = non-stationarity factor. "BT2015" uses
  #       formulation of Boore and Thompson (2012; 2015),
  #       "CS1961" uses Caughey and Stumpf (1961)
  #       analytical correction and "C1970" uses the 
  #       Corotis (1970) approximation.
  # Dgm = Duration (s). 
  #       if nf == "BT2015", then Dgm should be the 
  #         2xD20-80 significant duration of the as-recorded
  #         ground motion.
  #       if nf == "CS1961" or "C1970" then Dgm should be the
  #         oscillator duration
  #
  ################## OUTPUTS ###########################
  #
  # Output is a numeric array with the peak acceleration
  # response. Array length is the same as f0.
  #
  ######################################################
  
  # Calculate SDOF transfer function for PSA
  w <- 2 * pi * f
  w0 <- 2 * pi * f0
  A <- 1
  
  Hf <- matrix(data=NA,nrow=length(f0),ncol=length(f))
  lambda <- matrix(data=NA,nrow=length(f0),ncol=length(f))
  m0<-0
  m1<-0
  m2<-0
  m4<-0
  m0.ns<-0
  for (i in 1:length(f0)){
    lambda[i,] <- w / w0[i]
    if (f0[i]==0){
      Hf[i,] <- 1
    } else {
      Hf[i,] <- A/(sqrt((1-lambda[i,]^2)^2+(4*xi^2)*lambda[i,]^2))   
    }
    # Now calculate spectral moments
    if (nf=="BT2015" || nf=="C1970"){
      m0[i] <- 2*trapz(f,(abs(FA)^2)*(abs(Hf[i,])^2))
      m1[i] <- 2*trapz(f,(2*pi*f)*(abs(FA)^2)*(abs(Hf[i,])^2))
      m2[i] <- 2*trapz(f,(2*pi*f)^2*(abs(FA)^2)*(abs(Hf[i,])^2))
      m4[i] <- 2*trapz(f,(2*pi*f)^4*(abs(FA)^2)*(abs(Hf[i,])^2)) 
    } else if (nf=="CS1961"){
      w1 <- w0[i]*sqrt((1-xi^2))
      timefactor.none <- 1
      m0[i] <- 2*trapz(f,(abs(FA)^2)*(abs(Hf[i,])^2)*timefactor.none)
      m1[i] <- 2*trapz(f,(2*pi*f)*(abs(FA)^2)*(abs(Hf[i,])^2)*timefactor.none)
      m2[i] <- 2*trapz(f,(2*pi*f)^2*(abs(FA)^2)*(abs(Hf[i,])^2)*timefactor.none)
      m4[i] <- 2*trapz(f,(2*pi*f)^4*(abs(FA)^2)*(abs(Hf[i,])^2)*timefactor.none) 
      timefactor <- 1+exp(-2*w0[i]*xi*Dgm)*(1+2*xi*w0[i]/w1*sin(w1*Dgm)*cos(w1*Dgm)+(xi^2*w0[i]^2+w^2-w1^2)/w1^2*sin(w1*Dgm)*sin(w1*Dgm))-
        2*exp(-xi*w0[i]*Dgm)*xi*w0[i]/w1*cos(w*Dgm)*sin(w1*Dgm)-2*exp(-xi*w0[i]*Dgm)*cos(w*Dgm)*cos(w1*Dgm)-
        2*w/w1*exp(-xi*w0[i]*Dgm)*sin(w*Dgm)*sin(w1*Dgm)  
      m0.ns[i] <- 2*trapz(f,(abs(FA)^2)*(abs(Hf[i,])^2)*timefactor)
    } else {
      stop("Not a valid selection for the nonstationarity factor")
    }
    
  }
  if (Dgm>0){
    # Note that this peak factor calculation does not currently apply
    # nonstationarity in the bandwidth
    pf <- GetPeakFactor(pf.model,m0,m1,m2,m4,Dgm,f0,xi,nf)
  } else {
    pf <- 0
  }
  
  if (nf=="BT2015"){
    # Calculate RMS duration
    eta <- 1/(f0*Dgm)
    # Get coefficients of Boore & Thomspon (2012) equation
    coef <- BT2012(M,R,pf.model)
    Drms<-0
    for (i in 1:length(f0)){
      if (f0[i]==0){
        Drms[i] <- Dgm 
      } else {
        Drms[i] <- Dgm *
          (coef$c1 + coef$c2 * ((1 - eta[i])^coef$c3)/(1 + eta[i]^coef$c3)) *
          (1 + (coef$c4/(2*pi*xi)) * (eta[i]/(1+coef$c5*eta[i]^coef$c6))^coef$c7)
      }
    }
  } else {
    Drms <- Dgm
  }
  
  # Peak motion
  if (nf=="C1970"){
    arms <- sqrt(m0/Drms)*sqrt(1-exp(-4*f0*pi*xi*Drms))
  } else if (nf=="BT2015"){
    arms <- sqrt(m0/Drms)
  } else if (nf=="CS1961"){
    arms <- sqrt(m0.ns/Drms)
  }
  amax <- arms*pf
  
  return(amax)
}

BT2012 <- function(mag,dist,pf.model){
  
  if (pf.model == "CL1956"){
    # Enforce bounds on M and R
    if (mag < 4){
      mag <- 4
    } else if (mag > 8){
      mag <- 8
    }
    if (dist < 2){
      dist <- 2
    } else if (dist > 500){
      dist <- 500
    }
    
    # Coefficients from BT2012 BSSA paper electronic supplement
    M <- c(4.000000,  4.500000,  5.000000,  5.500000,  6.000000,  6.500000,  7.000000,  7.500000,  8.000000)
    R <- c(2.00,3.17,5.02,7.96,12.62,20.00,31.70,50.24,79.62,126.19,200.00,317.00,502.40)
    c1 <- (matrix(c( 0.843120,  0.830640,  0.897010,  0.835740,  0.844850,  0.843480,  0.800780,  0.833520,  1.181800,  0.821100,  0.876010,  0.839710,  0.834550,  0.816450,  0.824400,  0.832420,  0.832410,  0.839940,  0.863290,  0.848250,  0.844460,  0.849780,  0.821290,  0.815440,  0.824140,  0.894730,  0.921470,  0.847790,  0.846770,  0.882830,  0.827850,  0.833930,  0.814290,  0.803500,  0.864550,  0.930680,  0.843430,  0.826030,  0.850780,  0.844060,  0.818730,  0.821300,  0.839010,  0.881540,  0.962540,  0.840200,  0.800740,  0.819570,  0.845970,  0.819360,  0.821490,  0.828850,  0.885990,  0.965610,  0.811720,  0.789710,  0.789070,  0.828630,  0.810630,  0.815170,  0.815770,  0.925260,  0.900700,  0.743760,  0.766920,  0.804100,  0.802890,  0.820580,  0.819980,  0.804010,  0.921240,  0.912130,  0.718770,  0.768060,  0.812210,  0.811790,  0.838050,  0.834610,  0.825160,  0.926780,  0.947810,  0.700650,  0.739440,  0.805130,  0.836440,  0.845680,  0.841420,  0.836940,  0.977870,  0.955510,  0.724080,  0.768830,  0.804460,  0.851250,  0.889360,  0.883600,  0.884010,  0.977090,  0.947660,  0.736210,  0.770460,  0.832550,  0.933280,  0.967860,  0.991910,  0.984630,  0.982110,  0.980360,  0.771450,  0.839240,  0.863170,  0.937290,  0.987560,  1.025500,  1.023300,  1.020000,  1.000200),nrow=9, ncol=13))
    c2 <- (matrix(c(-0.028671, -0.000000, -0.010484, -0.000001, -0.012609, -0.000001, -0.001023, -0.002070, -0.378750, -0.004736, -0.000001, -0.003044, -0.000003, -0.000000, -0.000000, -0.004086, -0.008344, -0.026168, -0.040771, -0.000058, -0.000000, -0.000000, -0.000005, -0.000000, -0.004037, -0.053853, -0.089899, -0.028493, -0.000000, -0.000000, -0.000000, -0.000000, -0.000028, -0.000003, -0.049497, -0.103540, -0.009402, -0.015203, -0.000000, -0.000000, -0.000000, -0.000001, -0.003887, -0.053242, -0.154680, -0.004062, -0.001116, -0.000000, -0.000000, -0.000000, -0.000000, -0.014510, -0.067109, -0.150690, -0.000485, -0.000000, -0.000000, -0.000000, -0.000000, -0.000006, -0.000125, -0.116050, -0.104080, -0.009020, -0.000000, -0.000000, -0.000000, -0.000000, -0.000000, -0.001840, -0.111090, -0.104590, -0.000001, -0.000000, -0.000002, -0.000000, -0.000000, -0.000329, -0.001057, -0.128260, -0.130270, -0.003087, -0.006142, -0.000000, -0.012787, -0.010589, -0.009243, -0.000000, -0.150870, -0.136870, -0.000004, -0.000000, -0.000000, -0.020805, -0.034678, -0.043347, -0.043273, -0.138000, -0.125990, -0.000000, -0.000002, -0.008986, -0.094425, -0.105750, -0.128060, -0.129110, -0.147210, -0.131810, -0.000000, -0.017176, -0.030913, -0.110010, -0.127800, -0.167040, -0.160310, -0.124010, -0.119990),nrow=9, ncol=13))
    c3 <- (matrix(c( 2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000,  2.000000),nrow=9, ncol=13))
    c4 <- (matrix(c( 1.731600,  1.696200,  1.718100,  1.385900,  1.239100,  1.133100,  0.996760,  0.946010,  0.761140,  1.862700,  1.820000,  1.596400,  1.311600,  1.190800,  1.121200,  1.091900,  1.106700,  0.964940,  1.879200,  1.828500,  1.546300,  1.512600,  1.211500,  1.066800,  1.046700,  1.088800,  0.950080,  2.085800,  1.970100,  1.940000,  1.489000,  1.401600,  1.095500,  1.090300,  1.067200,  1.029500,  1.713800,  1.751500,  1.694300,  1.693600,  1.337900,  1.066600,  1.072100,  1.074600,  0.849720,  1.712200,  1.605000,  1.553700,  1.638400,  1.296700,  1.265100,  1.051400,  1.082000,  0.924940,  1.515400,  1.388100,  1.394500,  1.591800,  1.312200,  1.176800,  1.186200,  1.098400,  0.936300,  1.176000,  1.226200,  1.265800,  1.303300,  1.421500,  1.317100,  1.209200,  1.082100,  1.030300,  0.981890,  1.150000,  1.386700,  1.367300,  1.475000,  1.535900,  1.461700,  1.095400,  1.112300,  0.775140,  0.847000,  1.417300,  1.625300,  1.631700,  1.636700,  1.426000,  1.319800,  1.050200,  0.793150,  0.844890,  1.207900,  1.682800,  1.917600,  2.118900,  2.241100,  1.383300,  1.093700,  0.678660,  0.846950,  1.227200,  1.738800,  2.037100,  2.263100,  2.417200,  1.496000,  1.435500,  0.755010,  0.842400,  1.271200,  1.950300,  2.339800,  2.739300,  2.946300,  3.000000,  2.567500),nrow=9, ncol=13))
    c5 <- (matrix(c( 1.169500,  1.323600,  1.279700,  1.201500,  0.993990,  0.934410,  0.800840,  0.821330,  2.486800,  1.611800,  1.462600,  1.363500,  1.106800,  0.989680,  0.926900,  1.043900,  1.152100,  0.909670,  1.782500,  1.661100,  1.466500,  1.400400,  1.057800,  0.841430,  0.712420,  1.413800,  1.160700,  2.622100,  2.221900,  1.838900,  1.447500,  1.423200,  0.933630,  1.012000,  1.396500,  1.739300,  2.735700,  2.302300,  1.802500,  1.670100,  1.305800,  0.955270,  0.976020,  1.462900,  1.136900,  3.711100,  2.598400,  1.952500,  1.861300,  1.393300,  1.183300,  0.863250,  1.422300,  1.610800,  4.206600,  2.852500,  1.968100,  1.860900,  1.435800,  1.113500,  1.054900,  1.653700,  1.459600,  5.372400,  3.134400,  2.049300,  1.908200,  1.714800,  1.528700,  1.166800,  1.746900,  1.718800,  5.788200,  4.241000,  3.231000,  2.351000,  1.787400,  1.690700,  1.659800,  1.806100,  1.983500,  4.388000,  3.172000,  3.769600,  3.075100,  2.545000,  2.228100,  1.858700,  2.709500,  1.642000,  3.386300,  3.045100,  3.540500,  3.794000,  3.611300,  3.081000,  3.154300,  2.641300,  1.792700,  1.544200,  2.407400,  3.539300,  5.636700,  4.432600,  4.790500,  4.132800,  2.325100,  2.162400,  1.225400,  1.756600,  3.387900,  6.602400,  5.896700,  5.780800,  4.574100,  3.915500,  3.395500),nrow=9, ncol=13))
    c6 <- (matrix(c( 2.167100,  2.030800,  1.929500,  1.990400,  2.053200,  2.032800,  2.146600,  2.105200,  3.405100,  2.012800,  1.954200,  1.976100,  2.041400,  2.054900,  2.053700,  2.035500,  1.990700,  2.243600,  2.007100,  1.924900,  1.944800,  1.907200,  2.002800,  2.073500,  2.158600,  2.021200,  2.401700,  1.850100,  1.775500,  1.801300,  1.905200,  1.897500,  2.054700,  2.082500,  2.060000,  2.132600,  1.833200,  1.809300,  1.799300,  1.794200,  1.937000,  2.044100,  2.031900,  2.000100,  2.644500,  1.778100,  1.798100,  1.854100,  1.770900,  1.922600,  1.890400,  2.085400,  2.148300,  2.399500,  1.786800,  1.912900,  1.888200,  1.770000,  1.863200,  1.888800,  1.941600,  2.176800,  2.289700,  1.995200,  1.910400,  1.872800,  1.828300,  1.791800,  1.811300,  1.937800,  2.208200,  2.146000,  1.931500,  1.885200,  1.771200,  1.769500,  1.719100,  1.702900,  1.707500,  2.261700,  2.268200,  2.194200,  2.186100,  1.745100,  1.668700,  1.620700,  1.633000,  1.698000,  2.094800,  2.294500,  2.119400,  2.002200,  1.731100,  1.594900,  1.545700,  1.562700,  1.578500,  2.014400,  2.148500,  2.320800,  1.928600,  1.620700,  1.593900,  1.583500,  1.562400,  1.596800,  2.068700,  2.067400,  1.991800,  1.768200,  1.445500,  1.421000,  1.404000,  1.565200,  1.552900,  1.644500,  1.678500),nrow=9, ncol=13))
    c7 <- (matrix(c( 0.962240,  0.955170,  1.016300,  0.818290,  0.748840,  0.711500,  0.592860,  0.610110,  0.516160,  0.965570,  1.007600,  0.896400,  0.779890,  0.699530,  0.676730,  0.663350,  0.647150,  0.586960,  0.959790,  0.967110,  0.867710,  0.849970,  0.709870,  0.651580,  0.628360,  0.677760,  0.626350,  0.956900,  0.984980,  1.023500,  0.815710,  0.785260,  0.665040,  0.631750,  0.627190,  0.635960,  0.875700,  0.868160,  0.917950,  0.890010,  0.745900,  0.659720,  0.672140,  0.649280,  0.550700,  0.833690,  0.807760,  0.811850,  0.864300,  0.734840,  0.723370,  0.634590,  0.651400,  0.578770,  0.754950,  0.710110,  0.723070,  0.836320,  0.732570,  0.698050,  0.681950,  0.647390,  0.565320,  0.573760,  0.636320,  0.712050,  0.712570,  0.772380,  0.733360,  0.678790,  0.640690,  0.619590,  0.488690,  0.588600,  0.721720,  0.730650,  0.804890,  0.815700,  0.783720,  0.638830,  0.659830,  0.397510,  0.464950,  0.727460,  0.808110,  0.836000,  0.845710,  0.787520,  0.748510,  0.662230,  0.431680,  0.515300,  0.678460,  0.812980,  0.909030,  0.937330,  0.959610,  0.786500,  0.682550,  0.409930,  0.524940,  0.698980,  0.827720,  0.930470,  0.977560,  1.024800,  0.836020,  0.850370,  0.480050,  0.584510,  0.713600,  0.846440,  0.954840,  1.033900,  1.099700,  1.156000,  1.107000),nrow=9, ncol=13))
    
  } else if (pf.model == "V1975"){
    
    # Enforce bounds on M and R
    if (mag < 2){
      mag <- 2
    } else if (mag > 8){
      mag <- 8
    }
    if (dist < 2){
      dist <- 2
    } else if (dist > 1262){
      dist <- 1262
    }
    # Coefficients from BT2015 BSSA paper electronic supplement  
    M <- c(2.000000,   2.500000,   3.000000,   3.500000,   4.000000,   4.500000,   5.000000,   5.500000,   6.000000,   6.500000,   7.000000,   7.500000,   8.000000)
    R <- c(2.00,3.17,5.02,7.96,12.62,20.00,31.70,50.24,79.62,126.19,200.00,317.00,502.40,796.26,1262)
    
    c1 <- matrix(c( 0.938210,   0.906250,   0.954620,   0.954710,   0.985350,   1.005200,   1.037700,   1.030900,   0.953830,   0.952150,   0.847600,   0.848570,   0.829600,   0.917300,   0.917040,   0.937180,   0.935980,   0.962290,   0.966330,   1.014600,   1.017100,   0.980170,   0.945120,   0.835700,   0.844600,   0.827840,   0.912960,   0.901500,   0.902900,   0.908890,   0.939200,   0.935810,   0.975730,   0.994720,   0.995950,   0.888410,   0.823760,   0.841160,   0.804380,   0.910280,   0.903170,   0.892970,   0.892760,   0.915160,   0.929220,   0.971380,   0.969110,   0.949270,   0.830640,   0.831180,   0.831090,   0.804390,   0.901250,   0.877770,   0.867180,   0.887640,   0.888760,   0.890160,   0.915340,   0.969190,   0.998590,   0.821190,   0.841730,   0.817730,   0.801770,   0.866890,   0.878510,   0.878400,   0.877760,   0.875180,   0.882020,   0.889530,   0.885840,   0.968880,   0.967920,   0.830270,   0.835870,   0.800620,   0.876950,   0.871600,   0.876220,   0.854600,   0.876150,   0.867920,   0.883590,   0.890810,   0.970300,   0.966020,   0.792800,   0.807100,   0.798420,   0.869950,   0.863490,   0.876160,   0.854300,   0.878540,   0.874580,   0.879240,   0.875550,   0.897380,   0.906600,   0.906900,   0.806310,   0.800280,   0.877170,   0.873820,   0.858000,   0.869860,   0.869250,   0.864430,   0.880200,   0.877210,   0.876860,   0.892630,   0.891450,   0.886510,   0.790170,   0.867060,   0.869770,   0.868210,   0.868910,   0.865960,   0.867160,   0.882990,   0.887280,   0.884650,   0.882610,   0.913620,   0.854140,   0.806030,   0.856000,   0.853830,   0.856760,   0.867390,   0.868870,   0.872920,   0.881090,   0.915210,   0.916250,   0.812130,   0.809500,   0.839870,   0.839090,   0.942740,   0.897780,   0.887460,   0.888430,   0.879230,   0.866970,   0.869250,   0.921690,   0.916250,   0.905000,   0.783680,   0.833480,   0.848470,   0.927800,   0.923380,   0.926920,   0.926690,   0.917790,   0.863040,   0.864420,   0.922020,   0.916250,   0.874650,   0.779130,   0.796420,   0.853110,   0.916870,   0.916870,   0.914040,   0.916010,   0.917960,   0.872230,   0.871760,   0.924400,   0.901660,   0.849790,   0.849210,   0.861120,   0.864660,   0.765190,   0.762750,   0.763600,   0.750430,   0.986560,   0.982230,   0.992500,   0.972000,   0.900330,   0.850960,   0.874200,   0.911490,   0.915670),nrow=13, ncol=15)
    c2 <- matrix(c(-0.010855,  -0.013842,  -0.017367,  -0.022724,  -0.037142,  -0.079855,  -0.110140,  -0.127830,  -0.070054,  -0.063909,   0.029173,   0.037971,   0.037795,  -0.009484,  -0.020501,  -0.011238,  -0.014412,  -0.034933,  -0.041605,  -0.091889,  -0.115120,  -0.087049,  -0.057894,   0.043465,   0.037971,   0.038043,  -0.004792,  -0.003313,  -0.002623,  -0.002442,  -0.026355,  -0.021367,  -0.065297,  -0.097720,  -0.102130,  -0.013411,   0.058690,   0.037448,   0.061992,  -0.012366,   0.000610,  -0.004718,  -0.004549,  -0.023639,  -0.024704,  -0.067563,  -0.066228,  -0.066168,   0.045533,   0.045848,   0.041397,   0.068202,  -0.000238,  -0.002158,  -0.002533,  -0.004744,  -0.012375,  -0.012697,  -0.021347,  -0.066298,  -0.115330,   0.052160,   0.036303,   0.050187,   0.063627,   0.001105,  -0.002616,  -0.002328,  -0.009541,  -0.008066,  -0.010754,  -0.015253,  -0.015647,  -0.082112,  -0.083387,   0.039773,   0.040004,   0.063627,  -0.002845,  -0.002761,  -0.002140,  -0.009990,  -0.010068,  -0.007455,  -0.020985,  -0.021136,  -0.088559,  -0.088750,   0.077154,   0.064961,   0.065461,  -0.002747,  -0.015186,  -0.001961,   0.002042,  -0.010773,  -0.012517,  -0.017595,  -0.007738,  -0.034213,  -0.042642,  -0.042581,   0.064943,   0.064629,  -0.015397,  -0.013411,  -0.008545,  -0.016889,  -0.010166,  -0.009083,  -0.023386,  -0.019654,  -0.011495,  -0.021242,  -0.020598,  -0.019235,   0.069645,  -0.015397,  -0.019883,  -0.022487,  -0.029032,  -0.014148,  -0.012447,  -0.030880,  -0.034937,  -0.004670,  -0.007449,  -0.037244,   0.017876,   0.069615,  -0.015580,  -0.023982,  -0.023982,  -0.029032,  -0.029288,  -0.033372,  -0.034762,  -0.065527,  -0.054518,   0.066737,   0.069987,   0.034299,   0.032322,  -0.102390,  -0.062138,  -0.059064,  -0.059064,  -0.029729,  -0.030770,  -0.033598,  -0.068060,  -0.050942,  -0.050943,   0.096183,   0.034245,   0.032322,  -0.092609,  -0.092975,  -0.095075,  -0.092508,  -0.092508,  -0.014568,  -0.033065,  -0.065890,  -0.050942,   0.009808,   0.091048,   0.091642,   0.032322,  -0.089089,  -0.076420,  -0.074049,  -0.077021,  -0.078804,  -0.033053,  -0.030922,  -0.085598,  -0.052901,   0.009808,   0.008981,   0.028008,   0.027432,   0.080208,   0.080186,   0.080528,   0.080363,  -0.139770,  -0.144570,  -0.140330,  -0.121240,  -0.052017,  -0.008690,  -0.004904,  -0.024487,  -0.023590),nrow=13, ncol=15)
    c3 <- matrix(c( 2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000),nrow=13, ncol=15)
    c4 <- matrix(c( 1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000,   1.000000),nrow=13, ncol=15)
    c5 <- matrix(c( 1.864600,   1.671300,   1.168700,   0.935150,   0.672040,   0.517790,   0.431020,   0.320440,   0.222640,   0.185710,   0.114750,   0.101650,   0.086760,   3.348700,   3.082400,   1.885400,   1.481600,   0.996450,   0.678210,   0.524030,   0.374390,   0.267400,   0.190340,   0.114750,   0.101650,   0.076176,   5.720300,   5.186400,   3.714700,   2.435800,   1.485600,   1.048000,   0.673550,   0.457980,   0.333830,   0.190340,   0.119830,   0.097668,   0.076344,  10.687000,   7.598200,   6.143600,   3.784200,   2.517300,   1.513600,   0.916760,   0.606390,   0.352790,   0.175210,   0.137650,   0.112110,   0.070143,  13.878000,  12.030000,   9.207900,   4.958500,   3.284100,   1.712100,   0.916760,   0.628530,   0.521520,   0.174940,   0.149250,   0.112110,   0.073044,  23.056000,  15.395000,  12.351000,   7.237200,   4.398800,   2.284100,   1.351200,   0.789210,   0.521520,   0.354040,   0.157440,   0.119000,   0.071003,  28.429000,  27.366000,  18.794000,  10.472000,   6.419400,   3.648400,   1.974700,   1.060600,   0.696760,   0.423070,   0.157440,   0.126220,   0.085002,  33.381000,  28.271000,  18.041000,  13.651000,   6.936200,   4.719500,   2.578100,   1.301700,   0.704190,   0.448710,   0.304630,   0.131970,   0.098341,  21.343000,  18.915000,  15.098000,  11.673000,   6.786700,   4.011300,   2.251800,   1.263100,   0.705530,   0.434300,   0.306000,   0.199280,   0.106170,  10.601000,  11.131000,   9.656900,   9.076600,   5.262200,   3.470400,   2.310800,   1.334000,   0.642480,   0.414390,   0.304800,   0.191300,   0.113090,  10.299000,  11.329000,  11.635000,   9.076600,   7.526000,   5.558100,   3.456700,   2.273100,   1.371900,   0.505080,   0.304800,   0.254390,   0.186980,  12.058000,  10.227000,  10.484000,   9.811300,   7.520100,   5.961800,   5.002400,   3.092500,   2.008400,   1.304200,   0.417840,   0.299000,   0.187280,   6.711800,   6.520200,   6.524700,   6.009400,   6.009400,   4.552600,   3.525400,   3.322900,   2.008400,   1.251600,   0.556830,   0.264460,   0.191680,   3.596900,   3.596900,   3.333300,   3.358400,   3.505000,   2.600700,   2.553000,   2.120000,   1.894900,   1.172900,   0.697880,   0.300190,   0.086195,   0.889980,   0.794900,   0.747660,   0.739590,   1.684900,   1.347200,   1.683000,   1.195700,   1.103700,   0.215410,   0.002056,   0.000006,   0.000000),nrow=13, ncol=15)
    c6 <- matrix(c( 2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000,   2.000000),nrow=13, ncol=15)
    c7 <- matrix(c( 1.073200,   1.066700,   1.275900,   1.294400,   1.373100,   1.392400,   1.339300,   1.344700,   1.162100,   1.163700,   1.149800,   1.154600,   1.046900,   1.006500,   1.005600,   1.190500,   1.190000,   1.269400,   1.297900,   1.341300,   1.290200,   1.148400,   1.166800,   1.162800,   1.127600,   1.055600,   0.990290,   1.016300,   1.036700,   1.124800,   1.207700,   1.192000,   1.245300,   1.227300,   1.209400,   1.150600,   1.162800,   1.080800,   1.055600,   0.903390,   1.007400,   0.999700,   1.003100,   1.073400,   1.164400,   1.211200,   1.198600,   1.152800,   1.149500,   1.131600,   1.118600,   1.049300,   0.903390,   0.886940,   0.898450,   0.999550,   1.019200,   1.024700,   1.135500,   1.199600,   1.161900,   1.079400,   1.103300,   1.085000,   1.073400,   0.843890,   0.899750,   0.899780,   0.946750,   0.950970,   1.001200,   1.005500,   1.010500,   1.152800,   1.168100,   1.112400,   1.101000,   1.045500,   0.836010,   0.837320,   0.913970,   0.883880,   0.941630,   0.951710,   0.967210,   0.985700,   1.126500,   1.118500,   1.074000,   1.075900,   1.074800,   0.830540,   0.821030,   0.911250,   0.883880,   0.934540,   0.933140,   0.965710,   0.989240,   0.998090,   1.038500,   1.049400,   1.075900,   1.075900,   0.824010,   0.840520,   0.863440,   0.859220,   0.917080,   0.922380,   0.965730,   0.969080,   1.045500,   1.078800,   1.114800,   1.116800,   1.093300,   0.824010,   0.825200,   0.831370,   0.837870,   0.904860,   0.922120,   0.933070,   0.957920,   1.109300,   1.108700,   1.126700,   1.119200,   1.165700,   0.808200,   0.770140,   0.770140,   0.829970,   0.832420,   0.832270,   0.872290,   0.924580,   0.966360,   1.060200,   1.110500,   1.166700,   1.167400,   0.787370,   0.772630,   0.762270,   0.762270,   0.822970,   0.807240,   0.823890,   0.906510,   0.957240,   0.957240,   1.095100,   1.115100,   1.167400,   0.744640,   0.744460,   0.756630,   0.757140,   0.757140,   0.811700,   0.825190,   0.904960,   0.957240,   0.996840,   1.074400,   1.158600,   1.167400,   0.747670,   0.779400,   0.779090,   0.785720,   0.789420,   0.812190,   0.805760,   0.865560,   0.897770,   0.979140,   0.982960,   1.140100,   1.230400,   0.817860,   0.814080,   0.818150,   0.802700,   0.838890,   0.820460,   0.850090,   0.871450,   0.899710,   0.930940,   1.031600,   1.169600,   1.211300),nrow=13, ncol=15)
  } else {
    stop("Specified peak factor model is not supported")
  }
  
  grid.c1<-list(x=M,y=R,z=c1)
  grid.c2<-list(x=M,y=R,z=c2)
  grid.c3<-list(x=M,y=R,z=c3)
  grid.c4<-list(x=M,y=R,z=c4)
  grid.c5<-list(x=M,y=R,z=c5)
  grid.c6<-list(x=M,y=R,z=c6)
  grid.c7<-list(x=M,y=R,z=c7)   
  
  loc <- matrix(data=c(mag,dist),nrow=1,ncol=2)
  
  coef <- vector("list",7)
  names(coef) <- c("c1","c2","c3","c4","c5","c6","c7")
  coef$c1<-interp.surface(grid.c1,loc)
  coef$c2<-interp.surface(grid.c2,loc)
  coef$c3<-interp.surface(grid.c3,loc)
  coef$c4<-interp.surface(grid.c4,loc)
  coef$c5<-interp.surface(grid.c5,loc)
  coef$c6<-interp.surface(grid.c6,loc)
  coef$c7<-interp.surface(grid.c7,loc)
  
  return(coef)
  
}

GetPeakFactor <- function(pf.model,m0,m1,m2,m4,Dgm,f0,xi,nf){
  
  if (pf.model == "CL1956"){
    zeta <- sqrt((m2^2)/(m0*m4))
    Ne <- Dgm*sqrt(m4/m2)/pi
    
    # Calculate peak factor
    pf<-0
    for (i in 1:length(f0)){
      integrand <- function(z){1-(1-zeta[i]*exp(-z^2))^Ne[i]}
      tmp <- integrate(integrand,lower=0,upper=Inf)
      pf[i] <- tmp$value*sqrt(2)
    }
    
  } else if (pf.model == "V1975"){
    
    del.e <- ( sqrt(1-(m1^2)/(m0*m2)) )^1.2 # Effective bandwidth
    Nz <- Dgm*sqrt(m2/m0)/pi
    # Corotis (1970) nonstationary bandwidth approximation (not recommended hence commented)
#     del.e <- (sqrt(1-(1-2*xi/pi*(1-exp(-2*w0*xi*Dgm)+2*exp(-w0*xi*Dgm))/(1-exp(-2*w0*xi*Dgm)))^2))^1.2
#     del.e <- min(del.e,1)
    # Calculate peak factor
    pf<-0
    for (i in 1:length(f0)){
      integrand <- function(z){
        1-(1-exp(-z^2/2))*exp(-1*Nz[i]*exp(-z^2/2)*(1-exp(-1*sqrt(pi/2)*del.e[i]*z))/(1-exp((-1*z^2)/2)))
      }
      tmp <- integrate(integrand,lower=0,upper=Inf)
      pf[i] <- tmp$value      
    }  
    
  } else {
    stop("Specified peak factor model is not supported")
  }
  
  return(pf)
  
}
